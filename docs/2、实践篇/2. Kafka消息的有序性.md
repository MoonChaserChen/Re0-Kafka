# Kafka消息的有序性
Kafka保证一个Partition内的消息的有序性。

但由于Kafka的一个Topic可以分为了多个Partition，Producer发送消息的时候，是分散在不同 Partition的。
当Producer按顺序发消息给Broker，但进入Kafka之后，这些消息就不一定进到哪个Partition，会导致顺序是乱的。

## 一、实现方式
### 全局有序
要求：一个Topic下所有的消息都是有序的。

要满足全局有序，需要1个Topic只能对应1个Partition。

### 局部有序
要求：一个Topic下指定的一组消息有序。比如订单消息（消息内容包括：订单id、订单消息类型(创建、取消、支付、超时)等），这时只要求同一个订单id的所有类型消息有序。

将这一组消息Hash到同一个Partition。

## 二、消息重试对顺序消息的影响
对于一个有着先后顺序的消息A、B，正常情况下应该是A先发送完成后再发送B，但是在异常情况下，在A发送失败的情况下，B发送成功，而A由于重试机制在B发送完成之后重试发送成功了。这时对于本身顺序为AB的消息顺序变成了BA。

### 解法一
设置 `max.in.flight.requests.per.connection=1`。 该参数指定了生产者在收到服务器响应之前可以发送多少个消息。
它的值越高，就会占用越多的内存，同时也会提升吞吐量。把它设为1就可以保证消息是按照发送的顺序写入服务器的。

但这种方式会严重降低吞吐量。

### 解法二
可以考虑在消费端增加失败标记的记录，然后用定时任务轮询去重试这些失败的消息并做好监控报警。